<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Timer obscure behaviour | Pan Docs</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="">
    <link rel="preload" href="/pandocs/assets/css/0.styles.ba7fe2d2.css" as="style"><link rel="preload" href="/pandocs/assets/js/app.4c664a63.js" as="script"><link rel="preload" href="/pandocs/assets/js/2.a38a3f6e.js" as="script"><link rel="preload" href="/pandocs/assets/js/5.ce9e56ed.js" as="script"><link rel="prefetch" href="/pandocs/assets/js/3.3e62d0d5.js"><link rel="prefetch" href="/pandocs/assets/js/4.2e4856d6.js"><link rel="prefetch" href="/pandocs/assets/js/6.d84e7454.js">
    <link rel="stylesheet" href="/pandocs/assets/css/0.styles.ba7fe2d2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="timer-obscure-behaviour"><a href="#timer-obscure-behaviour" class="header-anchor">#</a> Timer obscure behaviour</h1> <h2 id="timer-global-circuit"><a href="#timer-global-circuit" class="header-anchor">#</a> Timer Global Circuit</h2> <p><img src="imgs/timer_simplified.svg" alt="" title="imgs/timer_simplified.svg"></p> <h2 id="relation-between-timer-and-divider-register"><a href="#relation-between-timer-and-divider-register" class="header-anchor">#</a> Relation between Timer and Divider register</h2> <p>This is a schematic of the circuit involving TAC and DIV:</p> <p><img src="imgs/timer_tac_bug_dmg.svg" alt="" title="imgs/timer_tac_bug_dmg.svg"></p> <p>Notice how the values that are connected to the inputs of the
multiplexer are the values of those bits, not the carry of those bits.
This is the reason of a few things:</p> <ul><li><p>When writing to DIV, the whole counter is reseted, so the timer is
also affected.</p></li> <li><p>When writing to DIV, if the current output is 1 and timer is
enabled, as the new value after reseting DIV will be 0, the falling
edge detector will detect a falling edge and TIMA will increase.</p></li> <li><p>When writing to TAC, if the previously selected multiplexer input was
1 and the new input is 0, TIMA will increase too. This doesnt
happen when the timer is disabled, but it also happens when disabling
the timer (the same effect as writing to DIV). The following code explains the behaviour in DMG and MGB.</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>    clocks_array[4] = {1024, 16, 64, 256}

    old_clocks = clocks_array[old_TAC&amp;3]
    new_clocks = clocks_array[new_TAC&amp;3]

    old_enable = old_TAC &amp; BIT(2)
    new_enable = new_TAC &amp; BIT(2)

    sys_clocks = 16 bit system counter

    IF old_enable == 0 THEN
        glitch = 0 (*)
    ELSE
        IF new_enable == 0 THEN
            glitch = (sys_clocks &amp; (old_clocks/2)) != 0
        ELSE
            glitch = ((sys_clocks &amp; (old_clocks/2)) != 0) &amp;&amp; ((sys_clocks &amp; (new_clocks/2)) == 0)
        END IF
    END IF
</code></pre></div><p>The sentence marked with a (*) has a different behaviour in GBC (AGB
and AGS seem to have strange behaviour even in the other statements).
When enabling the timer and maintaining the same frequency it doesnt
glitch. When disabling the timer it doesnt glitch either. When another
change of value happens (so timer is enabled after the write), the
behaviour depends on a race condition, so it cannot be predicted for
every device.</p> <h2 id="timer-overflow-behaviour"><a href="#timer-overflow-behaviour" class="header-anchor">#</a> Timer Overflow Behaviour</h2> <p>When TIMA overflows, the value from TMA is loaded and IF timer flag is
set to 1, but this doesnt happen immediately. Timer interrupt is
delayed 1 cycle (4 clocks) from the TIMA overflow. The TMA reload to
TIMA is also delayed. For one cycle, after overflowing TIMA, the value
in TIMA is 00h, not TMA. This happens only when an overflow happens, not
when the upper bit goes from 1 to 0, it cant be done manually writing
to TIMA, the timer has to increment itself.</p> <p>For example (SYS is the system internal counter divided by 4 for easier
understanding, each increment of the graph is 1 cycle, not 1 clock):</p> <div class="language- extra-class"><pre><code>Timer overflows:

              [A] [B]
SYS  FD FE FF |00| 01 02 03
TIMA FF FF FF |00| 23 23 23
TMA  23 23 23 |23| 23 23 23
IF   E0 E0 E0 |E0| E4 E4 E4

Timer doesn't overflow:

              [C]
SYS  FD FE FF 00 01 02 03
TIMA 45 45 45 46 46 46 46
TMA  23 23 23 23 23 23 23
IF   E0 E0 E0 E0 E0 E0 E0
</code></pre></div><ul><li><p>During the strange cycle [A] you can prevent the IF flag from being
set and prevent the TIMA from being reloaded from TMA by writing a value
to TIMA. That new value will be the one that stays in the TIMA register
after the instruction. Writing to DIV, TAC or other registers wont
prevent the IF flag from being set or TIMA from being reloaded.</p></li> <li><p>If you write to TIMA during the cycle that TMA is being loaded to it
[B], the write will be ignored and TMA value will be written to TIMA
instead.</p></li> <li><p>If TMA is written the same cycle it is loaded to TIMA [B], TIMA is
also loaded with that value.</p></li> <li><p>This is a guessed schematic to explain the priorities with registers
TIMA and TMA:</p></li></ul> <p><img src="imgs/timer_tima_tma_detailed.svg" alt="" title="imgs/timer_tima_tma_detailed.svg"></p> <p>TMA is a latch. As soon as it is written, the output shows that value.
That explains that when TMA is written and TIMA is being incremented,
the value written to TMA is also written to TIMA. It doesnt affect the
IF flag, though.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/pandocs/assets/js/app.4c664a63.js" defer></script><script src="/pandocs/assets/js/2.a38a3f6e.js" defer></script><script src="/pandocs/assets/js/5.ce9e56ed.js" defer></script>
  </body>
</html>
